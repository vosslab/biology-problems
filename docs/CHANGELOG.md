# Changelog

## 2026-01-26
- Added [problems/matching_sets/color_render_test.pg](../problems/matching_sets/color_render_test.pg) as a single-page PGML color rendering probe for MathJax and CSS styling methods.
- Added [docs/webwork/COLOR_TEXT_IN_WEBWORK.md](webwork/COLOR_TEXT_IN_WEBWORK.md) to document reliable CSS-based coloring and MathJax color failures in this WeBWorK setup.
- Linked [docs/webwork/COLOR_TEXT_IN_WEBWORK.md](webwork/COLOR_TEXT_IN_WEBWORK.md) from [docs/webwork/INDEX.md](webwork/INDEX.md).
- Expanded [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) sub/sup conversion to unescape entities inside tags, normalize minus signs, and map common letter subscripts/superscripts while leaving Greek letters on baseline.
- Documented the color-class migration plan for matching sets in [docs/webwork/COLOR_CLASS_MIGRATION_PLAN.md](webwork/COLOR_CLASS_MIGRATION_PLAN.md) and linked it from [docs/webwork/INDEX.md](webwork/INDEX.md).
- Added [docs/webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md](webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md) to define handling plans for sub/sup, tables, colors, and other replacement-rule cases, and linked it from [docs/webwork/INDEX.md](webwork/INDEX.md).
- Refined the replacement-rules plan to note baseline Greek handling, named color parsing, and bold/italic scope for strict conversions in [docs/webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md](webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md).
- Added shared HTML sanitization and strict color-span parsing helpers to [webwork_lib.py](../webwork_lib.py) for reuse across PGML generators.
- Updated [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to support strict replacement-rule color conversion (inline or class mode), PGML-safe sanitization, and table/unsupported span warnings.
- Added pytest coverage for new WebWork helper utilities in [tests/test_webwork_lib.py](../tests/test_webwork_lib.py).
- Added [docs/webwork/HTML_TO_WEBWORK_PLAN.md](webwork/HTML_TO_WEBWORK_PLAN.md) as the master HTML-to-PGML plan and [docs/webwork/NICETABLES_TRANSLATION_PLAN.md](webwork/NICETABLES_TRANSLATION_PLAN.md) for table translation guidance, and linked both from [docs/webwork/INDEX.md](webwork/INDEX.md).
- Adjusted PGML tag wrapper output in [webwork_lib.py](../webwork_lib.py) to use double quotes inside wrappers to avoid PG compile errors, and updated tests accordingly in [tests/test_webwork_lib.py](../tests/test_webwork_lib.py).
- Updated [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) to render colored labels via PGML tag wrappers in the statement block instead of storing wrappers inside match data.
- Switched [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) right-column labels to inline HTML span styling with escaped `A\.` prefixes so PGML does not auto-build ordered lists.
- Reworked [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) to emit right-column labels via HTML built in Perl and injected through `MODES(HTML => ...)` so span styling survives PGML.
- Adjusted [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) to inject right-column HTML directly from a PGML eval block to avoid `MODES(...)` returning `1`.
- Removed PGML parsing on right-column HTML injection in [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) so raw HTML labels render.
- Updated [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to build HTML-safe answer labels (with strict color span support) and emit them via `[$answers_html[...]]*` so right-column colors survive PGML rendering.
- Added HTML sanitization and span builders to [webwork_lib.py](../webwork_lib.py) and corresponding tests in [tests/test_webwork_lib.py](../tests/test_webwork_lib.py) to support safe raw HTML label output.
- Updated [problems/matching_sets/yaml_which_one_mc_to_pgml.py](../problems/matching_sets/yaml_which_one_mc_to_pgml.py) to render strict color spans as safe HTML in prompts/choices, pass them through PGML with `*`, and add optional class-based styling support.
- Updated [problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py](../problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py) to apply replacement rules with strict color-span handling, emit HTML-safe statements, and support inline coloring with `--no-color` to disable.
- Documented PGML single-pass behavior and the `[$var]*` HTML pass-through pattern across WebWork docs, including [docs/webwork/COLOR_TEXT_IN_WEBWORK.md](webwork/COLOR_TEXT_IN_WEBWORK.md), [docs/webwork/MATCHING_PROBLEMS.md](webwork/MATCHING_PROBLEMS.md), [docs/webwork/HTML_TO_WEBWORK_PLAN.md](webwork/HTML_TO_WEBWORK_PLAN.md), [docs/webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md](webwork/REPLACEMENT_RULES_IMPLEMENTATION_PLAN.md), [docs/webwork/COLOR_CLASS_MIGRATION_PLAN.md](webwork/COLOR_CLASS_MIGRATION_PLAN.md), and [docs/webwork/WEBWORK_PROBLEM_AUTHOR_GUIDE.md](webwork/WEBWORK_PROBLEM_AUTHOR_GUIDE.md).
- Moved shared replacement-rule helpers (normalize, apply, sanitize, color-span HTML formatting) into [webwork_lib.py](../webwork_lib.py) and updated [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py), [problems/matching_sets/yaml_which_one_mc_to_pgml.py](../problems/matching_sets/yaml_which_one_mc_to_pgml.py), and [problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py](../problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py) to use them.
- Simplified color flags across PGML generators: removed `--color-mode` in favor of default inline coloring plus `--no-color`, and repurposed `--use-colors` as an explicit enable (no MathJax).
- Added `--use-color` as an alias for `--use-colors` in the PGML YAML generators.
- Added generator unit tests in [tests/test_pgml_generators.py](../tests/test_pgml_generators.py) to cover matching, which-one, and MC statements PGML builders with inline color spans, plus additional helper coverage in [tests/test_webwork_lib.py](../tests/test_webwork_lib.py).
- Documented PGML renderer expectation mismatches and linter checks in [docs/webwork/PGML_LINTER_EXPECTATIONS.md](webwork/PGML_LINTER_EXPECTATIONS.md) and linked it from [docs/webwork/INDEX.md](webwork/INDEX.md).
- Expanded [docs/webwork/PGML_LINTER_EXPECTATIONS.md](webwork/PGML_LINTER_EXPECTATIONS.md) with additional structural, encoding, and macro sanity checks for poorly formed PGML files.
- Reverted [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) right-column output to PGML list markup with CSS coloring on `ol li:nth-child(...)` after inline HTML injection failed to render labels.
- Switched [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) to PGML tag wrappers for the two-column layout to keep right-column list items rendering with CSS nth-child coloring.
- Added fixed label-to-color HTML mapping in [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml) and emit it via `[$answers_html[...]]*` so label colors follow meaning instead of position.
- Documented the working fixed-label color approach for matching problems in [docs/webwork/COLOR_TEXT_IN_WEBWORK.md](webwork/COLOR_TEXT_IN_WEBWORK.md).

## 2026-01-24
- Updated [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to emit the `matching_from_web.pgml` MODES-based layout with HTML flexbox wrappers and TeX placeholders for reliable matching renders.
- Adjusted [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to strip HTML tags from YAML content, wrap prompt/choice variables in PGML brackets, color the right column via CSS on the container (position-based), and unescape HTML entities into Unicode characters.
- Converted `<sub>` and `<sup>` tags in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to Unicode subscripts/superscripts before stripping other HTML.
- Switched the right-column labels in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to escaped `A\.` text (avoids PGML ordered-list parsing), and normalized non-breaking spaces after entity unescape.
- Documented the `A\.` right-column label requirement in [docs/webwork/MATCHING_PROBLEMS.md](webwork/MATCHING_PROBLEMS.md) to prevent PGML ordered-list parsing.
- Set matching layout `MODES(TeX => '')` wrappers in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) since TeX output is not supported.
- Added `--use-colors` in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to bake MathJax-colored choice labels in Python using PGML math strings (`[\color{#HEX}{\text{...}}]`) from the qti color wheel palette, with stable ordering and CSS nth-child colors disabled when enabled.
- Defined `@ALPHABET` in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) to ensure matching labels render as A/B/C/etc.
- Refreshed WebWork docs to document PGML HTML whitelist constraints (blocked `table`/`tr`/`td`) and the MODES-based matching layout in [docs/webwork/MATCHING_PROBLEMS.md](webwork/MATCHING_PROBLEMS.md), [docs/webwork/WEBWORK_PROBLEM_AUTHOR_GUIDE.md](webwork/WEBWORK_PROBLEM_AUTHOR_GUIDE.md), [docs/webwork/WEBWORK_HEADER_STYLE.md](webwork/WEBWORK_HEADER_STYLE.md), and [docs/webwork/INDEX.md](webwork/INDEX.md).

## 2026-01-23
- Converted [problems/biochemistry-problems/which_hydrophobic-simple.py](../problems/biochemistry-problems/which_hydrophobic-simple.py) to self-contained PGML format as [problems/biochemistry-problems/which_hydrophobic-simple.pgml](../problems/biochemistry-problems/which_hydrophobic-simple.pgml).
- Fixed `NchooseK` undefined error in [problems/biochemistry-problems/which_hydrophobic-simple.pgml](../problems/biochemistry-problems/which_hydrophobic-simple.pgml) by adding `PGchoicemacros.pl` to the loadMacros list.
- Added concise two-sentence `BEGIN_PGML_HINT` to [problems/biochemistry-problems/which_hydrophobic-simple.pgml](../problems/biochemistry-problems/which_hydrophobic-simple.pgml) explaining that hydrophobic compounds are mostly carbon and hydrogen.
- Updated [source_me.sh](../source_me.sh) to add PGML linter (`pgml-lint`) to the environment setup, making it available as a shell function after sourcing the script.
- Enhanced [webwork_lib.py](../webwork_lib.py) to automatically populate OPL header fields (Date, Author, Institution) with default values when not specified in YAML files, affecting both [problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py](../problems/multiple_choice_statements/yaml_mc_statements_to_pgml.py) and [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py).
- Fixed potential unbound variable bug in [webwork_lib.py](../webwork_lib.py) KEYWORDS handling by moving keyword_blob append inside the else block.
- Improved [devel/commit_changelog.py](../devel/commit_changelog.py) to generate descriptive commit messages that include the first change and count remaining changes instead of just "docs: update changelog for DATE".
- Removed "docs: " prefix from [devel/commit_changelog.py](../devel/commit_changelog.py) commit messages to reduce noise (changelog entries are self-descriptive).
- Changed default output filename in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) from "matching-bond_types.pgml" to "bond_types-matching.pgml" so files don't all start with the same prefix.
- Verified that [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) preserves dark colors from replacement_rules in YAML files (colors already working via `<span style="color: ...">` tags).
- Created [problems/matching_sets/yaml_which_one_mc_to_pgml.py](../problems/matching_sets/yaml_which_one_mc_to_pgml.py) as PGML equivalent of [problems/matching_sets/yaml_make_which_one_multiple_choice.py](../problems/matching_sets/yaml_make_which_one_multiple_choice.py), generating "which one" multiple choice questions from matching set YAML files with support for --flip option.
- Fixed `NchooseK` undefined error in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) by adding `PGchoicemacros.pl` to the loadMacros list.
- Created [devel/add_dbsubject_to_yaml.py](../devel/add_dbsubject_to_yaml.py) script to automatically add `dbsubject` metadata to YAML files based on folder location.
- Added `dbsubject` field to 51 YAML files in [problems/matching_sets/](../problems/matching_sets/) and 47 YAML files in [problems/multiple_choice_statements/](../problems/multiple_choice_statements/) using folder-based subject mapping (biochemistry→Biochemistry, inheritance→Genetics, laboratory→Laboratory Techniques, etc.).
- Fixed PGML matching prompt/choice rendering in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) by emitting literal PGML variable references inside generated list blocks.
- Updated matching PGML outputs to use the corrected prompt/choice rendering in [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml), [problems/matching_sets/matching.pgml](../problems/matching_sets/matching.pgml), and [problems/matching_sets/matching-macromolecules-biol301.pgml](../problems/matching_sets/matching-macromolecules-biol301.pgml).
- Switched matching PGML rendering to emit explicit prompt/choice lines (no runtime join) in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) and refreshed [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml), [problems/matching_sets/matching.pgml](../problems/matching_sets/matching.pgml), and [problems/matching_sets/matching-macromolecules-biol301.pgml](../problems/matching_sets/matching-macromolecules-biol301.pgml) to ensure PGML parses the dropdowns and text.
- Adjusted matching PGML prompt/choice substitutions to use raw PGML eval blocks so HTML in prompts/choices renders correctly in [problems/matching_sets/yaml_match_to_pgml.py](../problems/matching_sets/yaml_match_to_pgml.py) and [problems/matching_sets/bond_types-matching.pgml](../problems/matching_sets/bond_types-matching.pgml).
- Added [problems/matching_sets/matching_full_fix.pgml](../problems/matching_sets/matching_full_fix.pgml) as a parserPopUp-based matching example (MatchingAlt-style, HTML-only layout) derived from [problems/matching_sets/matching_semifix.pgml](../problems/matching_sets/matching_semifix.pgml).
- Replaced the PGML solution join block in [problems/matching_sets/matching_full_fix.pgml](../problems/matching_sets/matching_full_fix.pgml) with a precomputed answer string to avoid unstable inline evaluation.

## 2026-01-22
- Resolved merge conflicts in [docs/CODE_ARCHITECTURE.md](docs/CODE_ARCHITECTURE.md) and [docs/FILE_STRUCTURE.md](docs/FILE_STRUCTURE.md) to align test/tool references with the current repo layout.
- Standardized lxml etree imports in gene mapping and treelib HTML validation helpers after merge resolution.
- Removed legacy [problems/multiple_choice_statements/yaml_to_pg.py](../problems/multiple_choice_statements/yaml_to_pg.py) during conflict cleanup to match the current PGML workflow.
